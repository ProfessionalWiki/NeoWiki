name: CI (TypeScript)

on:
  push:
    paths-ignore:
      - '.github/workflows/ci-php.yml'
      - 'src/**'
      - 'tests/**'
  pull_request:
    paths-ignore:
      - '.github/workflows/ci-php.yml'
      - 'src/**'
      - 'tests/**'

jobs:
  build:
    name: "Build"

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: ProfessionalWiki/Neo
          path: Neo
          token: ${{ secrets.NEO_READ_FPAT }}
          # Expected to expire on Sep 12 2025
          # https://github.com/organizations/ProfessionalWiki/settings/secrets/actions/NEO_READ_FPAT (enter new value)
          # (Re)generate token with contents read access for Neo and NeoExtension at https://github.com/settings/tokens?type=beta

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install NeoJS dependencies
        run: npm install
        working-directory: Neo/neojs

      - name: Build NeoJS
        run: npm run build
        working-directory: Neo/neojs

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

  test:
    name: "Tests"

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: ProfessionalWiki/Neo
          path: Neo
          token: ${{ secrets.NEO_READ_FPAT }}
          # Expected to expire on Sep 12 2025
          # https://github.com/organizations/ProfessionalWiki/settings/secrets/actions/NEO_READ_FPAT (enter new value)
          # (Re)generate token with contents read access for Neo and NeoExtension at https://github.com/settings/tokens?type=beta

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install NeoJS dependencies
        run: npm install
        working-directory: Neo/neojs

      - name: Build NeoJS
        run: npm run build
        working-directory: Neo/neojs

      - name: Install dependencies
        run: npm install

      - name: Test
        run: npm run test

      - name: Report Coverage
        if: always()
        uses: davelosert/vitest-coverage-report-action@v2
        working-directory: ./resources/ext.neowiki

  lint:
    name: "Linting"

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Lint
        run: npm run lint

  i18n:
    name: "i18n"

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Lint i18n
        run: npm run lint:i18n
