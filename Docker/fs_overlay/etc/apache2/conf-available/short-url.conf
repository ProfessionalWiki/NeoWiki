<Directory /var/www/html>
    RewriteEngine on

    RewriteRule ^/?wiki(/.*)?$ %{DOCUMENT_ROOT}/w/index.php [L]
    RewriteRule ^/?$ %{DOCUMENT_ROOT}/w/index.php [L]

    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-f
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-d
    RewriteRule ^/?w/images/thumb/[0-9a-f]/[0-9a-f][0-9a-f]/([^/]+)/([0-9]+)px-.*$ %{DOCUMENT_ROOT}/w/thumb.php?f=$1&width=$2 [L,QSA,B]

    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-f
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-d
    RewriteRule ^/?w/images/thumb/archive/[0-9a-f]/[0-9a-f][0-9a-f]/([^/]+)/([0-9]+)px-.*$ %{DOCUMENT_ROOT}/w/thumb.php?f=$1&width=$2&archived=1 [L,QSA,B]

    # Rewrite /index.php?title=PageName to /PageName
    RewriteCond %{QUERY_STRING} ^title=(.+)$ [NC]
    RewriteRule ^index\.php$ /%1? [R=301,L]

    # Rewrite /w/index.php/PageName and /index.php/PageName to /PageName
    RewriteCond %{REQUEST_URI} ^/w/index\.php/(.+)$ [NC,OR]
    RewriteCond %{REQUEST_URI} ^/index\.php/(.+)$ [NC]
    RewriteRule ^ /%1? [R=301,L]

    RewriteCond %{REQUEST_URI} !^/w/rest\.php
    RewriteCond %{REQUEST_URI} !^/w/img_auth\.php
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-f
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-d
    RewriteRule ^(.*)$ %{DOCUMENT_ROOT}/w/index.php [L]
</Directory>
